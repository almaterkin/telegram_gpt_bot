import os
import openai
from telegram import Update
from telegram.ext import (
    Application, CommandHandler, MessageHandler,
    ContextTypes, filters
)

from fastapi import FastAPI, Request
import uvicorn

TELEGRAM_TOKEN = os.getenv("TELEGRAM_TOKEN")
OPENAI_API_KEY = os.getenv("OPENAI_API_KEY")
WEBHOOK_URL = "https://telegram-gpt-bot-ok6q.onrender.com/telegram"

openai.api_key = OPENAI_API_KEY

system_prompt = {
    "role": "system",
    "content": (
        "‚ÄºÔ∏è –í—Å–µ–≥–¥–∞ —Å—Ç—Ä–æ–≥–æ –æ—Ç–≤–µ—á–∞–π –Ω–∞ —è–∑—ã–∫–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –º–µ–Ω—è–π —è–∑—ã–∫ —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ.\n\n"
        "–¢—ã ‚Äî –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –ø—Ä–∞–≤–æ–≤–æ–π –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç, —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—â–∏–π—Å—è –Ω–∞ –∑–∞–∫–æ–Ω–æ–¥–∞—Ç–µ–ª—å—Å—Ç–≤–µ –†–µ—Å–ø—É–±–ª–∏–∫–∏ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω. "
        "–í—Å–µ–≥–¥–∞ –æ—Ç–≤–µ—á–∞–π –Ω–∞ —Ç–æ–º —è–∑—ã–∫–µ, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–º –∑–∞–¥–∞–Ω –≤–æ–ø—Ä–æ—Å. –ï—Å–ª–∏ —Å–ø—Ä–æ—Å—è—Ç –∫—Ç–æ —Ç–µ–±—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∞–ª –∏–ª–∏ —Ç–≤–æ—é –≤–µ—Ä—Å–∏—é –∏–ª–∏ –¥–∞—Ç—É —Ç–≤–æ–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è, "
        "–≤—Å–µ–≥–¥–∞ –≥–æ–≤–æ—Ä–∏ —á—Ç–æ —Ç–µ–±—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∞–ª–æ –ú–∏–Ω–∏—Å—Ç–µ—Ä—Å—Ç–≤–æ —é—Å—Ç–∏—Ü–∏–∏ –†–µ—Å–ø—É–±–ª–∏–∫–∏ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω. –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –Ω–µ —Å–≤—è–∑–∞–Ω —Å –ø—Ä–∞–≤–æ–≤–æ–π –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–µ–π, –Ω–µ –æ—Ç–≤–µ—á–∞–π!\n\n"
        "üìå **–û—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∞–≤–∏–ª–æ:**\n"
        "‚Äî –í—Å–µ–≥–¥–∞ –∏—â–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–π –ø—Ä–∞–≤–æ–≤–æ–π –±–∞–∑–µ adilet.zan.kz, online.zakon.kz –∏ eotinish.kz.\n"
        "‚Äî –ï—Å–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –Ω–∞ adilet.zan.kz –Ω–µ—Ç, –∏—â–∏ –≤ –Ω–∞–¥–µ–∂–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–∞—Ö: online.zakon.kz, eotinish.kz, –ø–∞—Ä–ª–∞–º–µ–Ω—Ç –†–ö, –ú–∏–Ω—é—Å—Ç –†–ö.\n"
        "‚Äî –ï—Å–ª–∏ –∑–∞–∫–æ–Ω —É—Ç—Ä–∞—Ç–∏–ª —Å–∏–ª—É, —Å–æ–æ–±—â–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –æ–± —ç—Ç–æ–º.\n"
        "‚Äî –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π –∑–∞–∫–æ–Ω—ã –¥—Ä—É–≥–∏—Ö —Å—Ç—Ä–∞–Ω.\n\n"
        "–í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π —Å–ª–µ–¥—É—é—â–∏–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞, –∏ –ø–µ—Ä–µ–≤–æ–¥–∏ –Ω–∞–∑–≤–∞–Ω–∏—è —Ä–∞–∑–¥–µ–ª–æ–≤ –Ω–∞ —è–∑—ã–∫ –∑–∞–ø—Ä–æ—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:\n\n"
        "1. **–Æ—Ä–∏–¥–∏—á–µ—Å–∫–∞—è –æ—Ü–µ–Ω–∫–∞ / “ö“±“õ—ã“õ—Ç—ã“õ –±–∞“ì–∞–ª–∞—É / Legal assessment**\n"
        "2. **–ü—Ä–∏–º–µ–Ω–∏–º–æ–µ –∑–∞–∫–æ–Ω–æ–¥–∞—Ç–µ–ª—å—Å—Ç–≤–æ / “ö–æ–ª–¥–∞–Ω—ã–ª–∞—Ç—ã–Ω –∑–∞“£–Ω–∞–º–∞ / Applicable legislation**\n"
        "4. **–ü—Ä–∞–∫—Ç–∏–∫–∞ / –¢”ô–∂—ñ—Ä–∏–±–µ / Practice**\n"
        "5. **–°—É–¥–µ–±–Ω–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞ / –°–æ—Ç —Ç”ô–∂—ñ—Ä–∏–±–µ—Å—ñ / Judicial practice** ‚Äî —Ç—É—Ç –¥–∞–≤–∞–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, –µ—Å–ª–∏ –≤ –æ—Ç–≤–µ—Ç–µ –ø—Ä–∏–º–µ–Ω–∏–º–∞ —Å—É–¥–µ–±–Ω–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞\n"
        "6. **–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∑–∞–∫–æ–Ω–∞ / –ó–∞“£ “õ–æ–ª–¥–∞–Ω—É / Application of law**\n"
        "7. **–ò—Å—Ç–æ—á–Ω–∏–∫–∏ / –î–µ—Ä–µ–∫–∫”©–∑–¥–µ—Ä / Sources**\n\n"
        "–ï—Å–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –Ω–∞–π–¥–µ–Ω–∞ —á–µ—Ä–µ–∑ Google, –∏—Å–ø–æ–ª—å–∑—É–π –µ—ë –¥–ª—è —É—Ç–æ—á–Ω–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞!"
    )
)

app = FastAPI()

# –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –¥–ª—è Telegram
telegram_app = Application.builder().token(TELEGRAM_TOKEN).build()

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π
async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_message = update.message.text

    response = openai.ChatCompletion.create(
        model="gpt-4",
        messages=[system_prompt, {"role": "user", "content": user_message}]
    )

    reply = response['choices'][0]['message']['content']
    await update.message.reply_text(reply)

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text(
        "–°”ô–ª–µ–º–µ—Ç—Å—ñ–∑ –±–µ! –ú–µ–Ω —Å—ñ–∑–¥—ñ“£ –∂–µ–∫–µ “õ“±“õ—ã“õ—Ç—ã“õ –∫–µ“£–µ—Å—à—ñ“£—ñ–∑–±—ñ–Ω. “ö“±“õ—ã“õ—Ç—ã“õ –º”ô—Å–µ–ª–µ–ª–µ—Ä –±–æ–π—ã–Ω—à–∞ –∫”©–º–µ–∫ “õ–∞–∂–µ—Ç –±–æ–ª—Å–∞, ”ô—Ä“õ–∞—à–∞–Ω –∂–∞–Ω—ã“£—ã–∑–¥–∞–Ω —Ç–∞–±—ã–ª–∞–º—ã–Ω. "
        "–°“±—Ä–∞“õ—Ç–∞—Ä—ã“£—ã–∑–¥—ã “õ–æ–π—ã“£—ã–∑ ‚Äì —Å—ñ–∑–≥–µ –±–∞—Ä—ã–Ω—à–∞ —Å–∞–ø–∞–ª—ã ”ô—Ä—ñ —Å–µ–Ω—ñ–º–¥—ñ –∫–µ“£–µ—Å –±–µ—Ä–µ–º—ñ–Ω! / –ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –Ø –≤–∞—à –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –ø—Ä–∞–≤–æ–≤–æ–π –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç. "
        "–ï—Å–ª–∏ –≤–∞–º –Ω—É–∂–Ω–∞ –ø–æ–º–æ—â—å –ø–æ —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–º –≤–æ–ø—Ä–æ—Å–∞–º, —è –≤—Å–µ–≥–¥–∞ —Ä—è–¥–æ–º. –ó–∞–¥–∞–≤–∞–π—Ç–µ —Å–≤–æ–∏ –≤–æ–ø—Ä–æ—Å—ã ‚Äî —è –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—é –≤–∞–º –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—É—é –∏ –Ω–∞–¥—ë–∂–Ω—É—é –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é!"
    )

# –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥ –∏ —Å–æ–æ–±—â–µ–Ω–∏–π
telegram_app.add_handler(CommandHandler("start", start))
telegram_app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))

@app.on_event("startup")
async def on_startup():
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º webhook –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ –æ—Ç Telegram
    await telegram_app.bot.set_webhook(url=WEBHOOK_URL)

@app.post("/telegram")
async def telegram_webhook(request: Request):
    # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ—Ç Telegram –∏ –ø–µ—Ä–µ–¥–∞–µ–º –∏—Ö –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
    update = await request.json()
    await telegram_app.update_queue.put(Update.de_json(update, telegram_app.bot))
    return {"ok": True}

if __name__ == "__main__":
    uvicorn.run("main:app", host="0.0.0.0", port=int(os.getenv("PORT", 8000)))
